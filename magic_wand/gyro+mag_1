#include <WiFiNINA.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_LSM303_U.h>
#include <Arduino_LSM6DS3.h>
#include "arduino_secrets.h"

// Sensors
Adafruit_LSM303_Mag_Unified mag = Adafruit_LSM303_Mag_Unified(12345);

// WiFi Settings
WiFiClient client;
const char server[] = "10.23.10.214"; 
const int portNum = 8080;
String deviceName = "drawing_wand";

// Timing for drawing (Needs to be fast!)
unsigned long lastSend = 0;
int interval = 50; // 20 frames per second for smooth lines

// Gyro Thresholds
int minThresh = 30;
int maxThresh = 500;

void setup() {
  Serial.begin(9600);
  
  // Initialize Sensors
  if(!mag.begin()) { Serial.println("LSM303 Fail"); while(1); }
  if(!IMU.begin()) { Serial.println("LSM6DS3 Fail"); while(1); }
  mag.enableAutoRange(true);

  // Connect WiFi
  WiFi.begin(SECRET_SSID, SECRET_PASS);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected! IP: " + WiFi.localIP().toString());
}

void loop() {
  // Ensure connection to the host computer
  if (!client.connected()) {
    if (client.connect(server, portNum)) {
      Serial.println("Connected to Server");
    } else {
      delay(1000);
      return; 
    }
  }

  if (millis() - lastSend > interval) {
    /* 1. Get Magnetometer Data */
    sensors_event_t event;
    mag.getEvent(&event);
    float heading = atan2(event.magnetic.y, event.magnetic.x) * 180 / M_PI;
    if (heading < 0) heading += 360;

    /* 2. Get Gyroscope Data */
    float gx, gy, gz;
    if (IMU.gyroscopeAvailable()) {
      IMU.readGyroscope(gx, gy, gz);
    }

    /* 3. Calculate Intensities */
    int speedY = 0;
    int speedX = 0;
    if (abs(gy) > minThresh) speedY = map(constrain(abs(gy), minThresh, maxThresh), minThresh, maxThresh, 0, 100);
    if (abs(gx) > minThresh) speedX = map(constrain(abs(gx), minThresh, maxThresh), minThresh, maxThresh, 0, 100);

    /* 4. Determine Cardinal Direction String */
    String dir = "FRONT";
    if (heading >= 45 && heading < 135) dir = "RIGHT";
    else if (heading >= 135 && heading < 225) dir = "BACK";
    else if (heading >= 225 && heading < 315) dir = "LEFT";

    /* 5. Format and Send JSON */
    // Format: {"device":"wand", "dir":"FRONT", "heading":120.5, "speedX":10, "speedY":5}
    String json = "{";
    json += "\"device\":\"" + deviceName + "\",";
    json += "\"dir\":\"" + dir + "\",";
    json += "\"heading\":" + String(heading) + ",";
    json += "\"speedX\":" + String(speedX) + ",";
    json += "\"speedY\":" + String(speedY);
    json += "}";

    client.println(json);
    lastSend = millis();
  }
}
